/*! @misonou/brew-extension-auth v0.3.1 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports.Auth=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,(function(e,n){return function(){"use strict";var r={760:function(n){n.exports=e},231:function(e){e.exports=n}},t={};function o(e){var n=t[e];if(void 0!==n)return n.exports;var u=t[e]={exports:{}};return r[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var r in n)o.o(n,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return function(){o.d(u,{default:function(){return K}});var e={};o.r(e),o.d(e,{invalidCredential:function(){return E},loggedIn:function(){return A},noProvider:function(){return H}});var n={};o.r(n),o.d(n,{AuthError:function(){return e},AuthProvider:function(){return z},JSONClient:function(){return D},createAxiosMiddleware:function(){return W},createFetchMiddleware:function(){return N},default:function(){return G}});var r=o(760),t=r.addExtension,i=r.combinePath,c=o(231),a=c.util,f=a.catchAsync,s=a.defineHiddenProperty,d=a.defineObservableProperty,l=a.each,p=a.errorWithCode,h=a.exclude,v=a.extend,g=a.is,y=a.isErrorWithCode,b=a.isFunction,w=a.makeArray,m=a.makeAsync,k=a.mapRemove,T=a.pick,x=a.pipe,P=a.reject,j=a.resolve,q=a.resolveAll,O=a.throws,S=c.dom.reportError,A="brew/auth-logged-in",H="brew/auth-no-provider",E="brew/auth-invalid-credential",I="brew.auth",C=t("auth",["router"],(function(e,n){var r,t,o=d(e,"user",null,!0),u=w(n.providers||n.provider),c={interaction:n.interaction||"redirect"},a=new Map,s=i(location.origin,e.toHref("/")),l=e.cache;function h(n){var o={redirectUri:s,revokeSession:function(o){r!==n||o&&t.accountId!==o||(r=null,e.emit("sessionEnded")||U())}};return a.set(n,o),j(n.init(o)).catch((function(e){y(e,E)||S(e)}))}function g(e,n,r){return void 0===r?e:e.filter((function(e){return e[n]===r}))}function C(e){if(e.provider)return g(u,"key",e.provider)[0];var n=u;return n=g(n,"authType",e.authType),n=g(n,"providerType",e.providerType),e.loginHint?j(0).then((function r(t){var o=n[t];return o&&j(o.isHandleable(e.loginHint)).then((function(e){return e?o:r(t+1)}))})):n[1]?void 0:n[0]}function M(e,n){l.set(I,{provider:e,returnPath:n})}function z(n){var r=k(l,I)||{};r.provider===n&&f(e.navigate(r.returnPath))}function R(u,i){var c={provider:u.key,providerType:u.providerType,account:i.account};return r=u,t=i,(n.resolveUser?m(n.resolveUser)(c):j(c.account)).then((function(n){o(n),z(u.key),e.emit("login",{user:n})}),(function(e){throw U(),e}))}function U(){var n=e.user;r=null,t=null,o(null),z(""),n&&e.emit("logout",{user:n})}function J(e,n,r,t){var o=m(e[n]).call(e,v({},c,r),a.get(e));return o.catch((function(){l.delete(I)})),o.then(t)}e.define({resolveAuthProvider:function(e){return j(C(e)).then((function(e){return e?T(e,["key","authType","providerType"]):null}))},acquireToken:function(e){var n=r,o=t,u=!0===e;return e=b(e)||j,n?!u&&t.expiresOn>Date.now()?e(t.accessToken,!0):n.refresh(t,a.get(n)).then((function(o){return r===n&&(t=o),e(o.accessToken,!1)}),(function(n){return u?O(n):e(o.accessToken,!1)})):e(null,!1)},login:function(t){return r?P(p(A)):j(C(t=t||{})).then((function(r){if(!r)throw p(H);return M(r.key,t.returnPath||n.postLoginPath||e.path),J(r,"login",T(t,["loginHint","password"]),R.bind(0,r))}))},logout:function(o){return r?(M("",(o=o||{}).returnPath||n.postLogoutPath||e.path),J(r,"logout",{accountId:t.accountId,singleLogout:o.singleLogout},U)):j(U())}}),e.beforeInit((function(){return q(u.map(h),(function(e){var n=u.indexOf(C(l.get(I)||{}));return e[n]||(n=e.findIndex(x)),n>=0?R(u[n],e[n]):U()}))}))})),M=c.util.bind,z={from:function(e,n){var r=window.localStorage,t="brew.auth."+e,o=t+".id";function u(e){return e?(r[t]=JSON.stringify(h(e,["account"])),r[o]=e.accountId):(delete r[t],delete r[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){M(window,"storage",(function(n){n.storageArea===r&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)}));var i=function(){try{return JSON.parse(r[t])}catch(e){}}();return i&&n.refresh(i).then(u)},login:function(e){return n.login(e).then(u)},logout:function(e){return n.logout(e).then(u.bind(0,void 0))},refresh:function(e){return n.refresh(e).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}},R="authorization";function U(e,n,r,t,o){return r&&n&&401===n.status?e(!0).then(t,o):o()}function J(e,n,r,t){return!g(r,Request)||t&&!b(t)?J(e,n,new Request(r,t)):(t=t||window.fetch,n&&!n(r)||r.headers.has(R)?t(r):e((function n(o,u){var i=r;return o&&(i=i.clone()).headers.set(R,"Bearer "+o),t(i).then((function(r){return U(e,r,u,n,(function(){return r}))}))})))}function L(e,n,r){var t=new WeakMap,o=function(e,n){return e.headers[R]="Bearer "+n,e};return r.interceptors.request.use((function(r){return n&&!n(r)||r.headers[R]?r:e((function(e,n){return t.set(r,n),e?o(r,e):r}))})),r.interceptors.response.use(void 0,(function(n){return U(e,(n=n||{}).response,t.get(n.config),(function(e){return r.create()(o(n.config,e))}),(function(){return P(n)}))})),r}function N(e,n){return J.bind(0,e.acquireToken,n)}function W(e,n){return L.bind(0,e.acquireToken,n)}var B=r.ErrorCode.apiError;function F(e,n,r){if(e.ok)return n;throw p(B,"",{data:n,error:r||null,status:e.status})}function V(e,n){return e.headers.set("accept","application/json"),(n||fetch)(e).then((function(e){return e.json().then((function(n){return F(e,n)}),(function(n){return F(e,null,n)}))}))}function _(e,n){n=n||function(e,n){return n(e)},this.baseUrl=e,this.request=function(r,t){return r=g(r,Request)||new Request(i(e,r),t),n(r,V)}}l("get post put patch delete",(function(e,n){var r=n.toUpperCase();s(_.prototype,n,(function(e,t,o){return this.request(e,"get"===n?t:function(e,n,r){return v({},r=r||{},{method:e,body:JSON.stringify(n),headers:v({},r.headers,{"content-type":"application/json"})})}(r,t,o))}))}));var D=_,G=C;Object.assign(G,n);var K=G}(),u=u.default}()}));
//# sourceMappingURL=brew-auth.min.js.map