/*! @misonou/brew-extension-auth v0.4.0 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports.Auth=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,(function(e,n){return function(){"use strict";var t={760:function(n){n.exports=e},231:function(e){e.exports=n}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var u=r[e]={exports:{}};return t[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return function(){o.d(u,{default:function(){return Q}});var e={};o.r(e),o.d(e,{invalidCredential:function(){return H},loggedIn:function(){return S},noProvider:function(){return R}});var n={};o.r(n),o.d(n,{AuthError:function(){return e},AuthProvider:function(){return M},JSONClient:function(){return G},createAxiosMiddleware:function(){return B},createFetchMiddleware:function(){return W},default:function(){return K}});var t=o(760),r=t.addExtension,i=t.combinePath,c=o(231),a=c.util,f=a.catchAsync,s=a.defineHiddenProperty,d=a.defineObservableProperty,l=a.each,p=a.errorWithCode,h=a.exclude,v=a.extend,g=a.is,y=a.isErrorWithCode,b=a.isFunction,w=a.makeArray,m=a.makeAsync,k=a.mapRemove,T=a.noop,x=a.pick,P=a.pipe,j=a.reject,A=a.resolve,q=a.resolveAll,I=a.throws,O=c.dom.reportError,S="brew/auth-logged-in",R="brew/auth-no-provider",H="brew/auth-invalid-credential",C="brew.auth",E=r("auth",["router"],(function(e,n){var t,r,o=d(e,"user",null,!0),u=w(n.providers||n.provider),c={interaction:n.interaction||"redirect"},a=new Map,s=i(location.origin,e.toHref("/")),l=e.cache,h=l.get(C)||{},g=0===performance.navigation.type;function T(n){var o={redirectUri:s,revokeSession:function(o){t!==n||o&&r.accountId!==o||(t=null,e.emit("sessionEnded")||J())}};return a.set(n,o),m(n.init).call(n,o).then((function(){if(g&&h.provider===n.key&&h.returnPath)return n.handleLoginRedirect(o)})).then((function(e){return e||n.getActiveAccount(o)})).catch((function(e){y(e,H)||O(e)}))}function E(e,n,t){return void 0===t?e:e.filter((function(e){return e[n]===t}))}function L(e){if(e.provider)return E(u,"key",e.provider)[0];var n=u;return n=E(n,"authType",e.authType),n=E(n,"providerType",e.providerType),e.loginHint?A(0).then((function t(r){var o=n[r];return o&&A(o.isHandleable(e.loginHint)).then((function(e){return e?o:t(r+1)}))})):n[1]?void 0:n[0]}function M(e,n){l.set(C,{provider:e,returnPath:n})}function z(n,t){var r=k(l,C)||{};r.provider===n&&r.returnPath&&f(e.navigate(r.returnPath)),n&&l.set(C,{provider:n,accountId:t})}function U(u,i){var c=h.provider===u.key&&h.accountId===i.accountId,a={provider:u.key,providerType:u.providerType,account:i.account};return t=u,r=i,(n.resolveUser?m(n.resolveUser)(a):A(a.account)).then((function(n){o(n),z(u.key,i.accountId),e.emit("login",{user:n,sessionResumed:c,sessionChanged:!c&&!!h.accountId}),h={}}),(function(e){throw J(),e}))}function J(){var n=e.user;t=null,r=null,o(null),z(""),(n||h.accountId)&&e.emit("logout",{user:n}),h={}}function N(e,n,t,r){var o=m(e[n]).call(e,v({},c,t),a.get(e));return o.catch((function(){l.delete(C)})),o.then(r)}e.define({resolveAuthProvider:function(e){return A(L(e)).then((function(e){return e?x(e,["key","authType","providerType"]):null}))},acquireToken:function(e){var n=t,o=r,u=!0===e;return e=b(e)||A,n?!u&&r.expiresOn>Date.now()?e(r.accessToken,!0):n.refresh(r,a.get(n)).then((function(o){return t===n&&(r=o),e(o.accessToken,!1)}),(function(n){return u?I(n):e(o.accessToken,!1)})):e(null,!1)},login:function(r){return t?j(p(S)):A(L(r=r||{})).then((function(t){if(!t)throw p(R);return M(t.key,r.returnPath||n.postLoginPath||e.path),N(t,"login",x(r,["loginHint","password"]),U.bind(0,t))}))},logout:function(o){return t?(M("",(o=o||{}).returnPath||n.postLogoutPath||e.path),N(t,"logout",{accountId:r.accountId,singleLogout:o.singleLogout},J)):A(J())}}),e.beforeInit((function(){return q(u.map(T),(function(e){var n=u.indexOf(L(h));return e[n]||(n=e.findIndex(P)),n>=0?U(u[n],e[n]).catch(O):J()}))}))})),L=c.util.bind,M={from:function(e,n){var t=window.localStorage,r="brew.auth."+e,o=r+".id";function u(e){return e?(t[r]=JSON.stringify(h(e,["account"])),t[o]=e.accountId):(delete t[r],delete t[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){return L(window,"storage",(function(n){n.storageArea===t&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)})),(n.init||T).call(n,e)},getActiveAccount:function(e){var o=function(){try{return JSON.parse(t[r])}catch(e){}}();return o&&n.refresh(o,e).then(u)},handleLoginRedirect:function(e){return A((n.handleLoginRedirect||T).call(n,e)).then(u)},login:function(e,t){return n.login(e,t).then(u)},logout:function(e,t){return n.logout(e,t).then(u.bind(0,void 0))},refresh:function(e,t){return n.refresh(e,t).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}},z="authorization";function U(e,n,t,r,o){return t&&n&&401===n.status?e(!0).then(r,o):o()}function J(e,n,t,r){return!g(t,Request)||r&&!b(r)?J(e,n,new Request(t,r)):(r=r||window.fetch,n&&!n(t)||t.headers.has(z)?r(t):e((function n(o,u){var i=t;return o&&(i=i.clone()).headers.set(z,"Bearer "+o),r(i).then((function(t){return U(e,t,u,n,(function(){return t}))}))})))}function N(e,n,t){var r=new WeakMap,o=function(e,n){return e.headers[z]="Bearer "+n,e};return t.interceptors.request.use((function(t){return n&&!n(t)||t.headers[z]?t:e((function(e,n){return r.set(t,n),e?o(t,e):t}))})),t.interceptors.response.use(void 0,(function(n){return U(e,(n=n||{}).response,r.get(n.config),(function(e){return t.create()(o(n.config,e))}),(function(){return j(n)}))})),t}function W(e,n){return J.bind(0,e.acquireToken,n)}function B(e,n){return N.bind(0,e.acquireToken,n)}var F=t.ErrorCode.apiError;function V(e,n,t){if(e.ok)return n;throw p(401===e.status?H:F,"",{data:n,error:t||null,status:e.status})}function _(e,n){return e.headers.set("accept","application/json"),(n||fetch)(e).then((function(e){return e.json().then((function(n){return V(e,n)}),(function(n){return V(e,null,n)}))}))}function D(e,n){n=n||function(e,n){return n(e)},this.baseUrl=e,this.request=function(t,r){return t=g(t,Request)||new Request(i(e,t),r),n(t,_)}}l("get post put patch delete",(function(e,n){var t=n.toUpperCase();s(D.prototype,n,(function(e,r,o){return this.request(e,"get"===n?r:function(e,n,t){return v({},t=t||{},{method:e,body:JSON.stringify(n),headers:v({},t.headers,{"content-type":"application/json"})})}(t,r,o))}))}));var G=D,K=E;Object.assign(K,n);var Q=K}(),u=u.default}()}));
//# sourceMappingURL=brew-auth.min.js.map