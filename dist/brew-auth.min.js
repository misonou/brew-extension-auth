/*! @misonou/brew-extension-auth v0.5.0 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports["@misonou/brew-extension-auth"]=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,function(e,n){return function(){"use strict";var t={231:function(e){e.exports=n},760:function(n){n.exports=e}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var u=r[e]={exports:{}};return t[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};o.d(u,{default:function(){return Y}});var i={};o.r(i),o.d(i,{invalidCredential:function(){return z},loggedIn:function(){return C},noProvider:function(){return M}});var c={};o.r(c),o.d(c,{AuthError:function(){return i},AuthProvider:function(){return N},JSONClient:function(){return Q},createAxiosMiddleware:function(){return D},createFetchMiddleware:function(){return _},default:function(){return X}});var a=o(760),d=a.addExtension,f=a.combinePath,s=o(231),l=s.util,p=l.catchAsync,h=l.defineHiddenProperty,v=l.defineObservableProperty,g=l.each,y=l.errorWithCode,b=l.exclude,w=l.extend,m=l.is,k=l.isErrorWithCode,T=l.isFunction,x=l.makeArray,P=l.makeAsync,A=l.mapRemove,q=l.noop,I=l.pick,j=l.pipe,O=l.reject,S=l.resolve,H=l.resolveAll,L=l.throws,R=s.dom.reportError,C="brew/auth-logged-in",M="brew/auth-no-provider",z="brew/auth-invalid-credential",E="brew.auth",U=d("auth",["router"],function(e,n){var t,r,o=v(e,"user",null,!0),u=x(n.providers||n.provider),i={interaction:n.interaction||"redirect"},c=new Map,a=f(location.origin,e.toHref("/")),d=e.cache,s=d.get(E)||{},l=0===performance.navigation.type;function h(n){var o={redirectUri:a,revokeSession:function(o){t!==n||o&&r.accountId!==o||(t=null,e.emit("sessionEnded")||J())}};return c.set(n,o),P(n.init).call(n,o).then(function(){if(l&&s.provider===n.key&&s.returnPath)return n.handleLoginRedirect(o)}).then(function(e){return e||n.getActiveAccount(o)}).catch(function(e){k(e,z)||R(e)})}function g(e,n,t){return void 0===t?e:e.filter(function(e){return e[n]===t})}function b(e){if(e.provider)return g(u,"key",e.provider)[0];var n=u;return n=g(n,"authType",e.authType),n=g(n,"providerType",e.providerType),e.loginHint?S(0).then(function t(r){var o=n[r];return o&&S(o.isHandleable(e.loginHint)).then(function(e){return e?o:t(r+1)})}):n[1]?void 0:n[0]}function m(e,n){d.set(E,{provider:e,returnPath:n})}function q(n,t){var r=A(d,E)||{};r.provider===n&&r.returnPath&&p(e.navigate(r.returnPath)),n&&d.set(E,{provider:n,accountId:t})}function U(u,i){var c=s.provider===u.key&&s.accountId===i.accountId,a={provider:u.key,providerType:u.providerType,account:i.account};return t=u,r=i,(n.resolveUser?P(n.resolveUser)(a):S(a.account)).then(function(n){o(n),q(u.key,i.accountId),e.emit("login",{user:n,sessionResumed:c,sessionChanged:!c&&!!s.accountId}),s={}},function(e){throw J(),e})}function J(){var n=e.user;t=null,r=null,o(null),q(""),(n||s.accountId)&&e.emit("logout",{user:n}),s={}}function N(e,n,t,r){var o=P(e[n]).call(e,w({},i,t),c.get(e));return o.catch(function(){d.delete(E)}),o.then(r)}e.define({resolveAuthProvider:function(e){return S(b(e)).then(function(e){return e?I(e,["key","authType","providerType"]):null})},acquireToken:function(e){var n=t,o=r,u=!0===e;return e=T(e)||S,n?!u&&r.expiresOn>Date.now()?e(r.accessToken,!0):n.refresh(r,c.get(n)).then(function(o){return t===n&&(r=o),e(o.accessToken,!1)},function(n){return u?L(n):e(o.accessToken,!1)}):e(null,!1)},login:function(r){return t?O(y(C)):S(b(r=r||{})).then(function(t){if(!t)throw y(M);return m(t.key,r.returnPath||n.postLoginPath||e.path),N(t,"login",I(r,["loginHint","password"]),U.bind(0,t))})},logout:function(o){return t?(m("",(o=o||{}).returnPath||n.postLogoutPath||e.path),N(t,"logout",{accountId:r.accountId,singleLogout:o.singleLogout},J)):S(J())}}),e.beforeInit(function(){return H(u.map(h),function(e){var n=u.indexOf(b(s));return e[n]||(n=e.findIndex(j)),n>=0?U(u[n],e[n]).catch(R):J()})})}),J=s.util.bind,N={from:function(e,n){var t=window.localStorage,r="brew.auth."+e,o=r+".id";function u(e){return e?(t[r]=JSON.stringify(b(e,["account"])),t[o]=e.accountId):(delete t[r],delete t[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){return J(window,"storage",function(n){n.storageArea===t&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)}),(n.init||q).call(n,e)},getActiveAccount:function(e){var o=function(){try{return JSON.parse(t[r])}catch(e){}}();return o&&n.refresh(o,e).then(u)},handleLoginRedirect:function(e){return S((n.handleLoginRedirect||q).call(n,e)).then(u)},login:function(e,t){return n.login(e,t).then(u)},logout:function(e,t){return n.logout(e,t).then(u.bind(0,void 0))},refresh:function(e,t){return n.refresh(e,t).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}},W="authorization";function B(e,n,t,r,o){return t&&n&&401===n.status?e(!0).then(r,o):o()}function F(e,n,t,r){return!m(t,Request)||r&&!T(r)?F(e,n,new Request(t,r)):(r=r||window.fetch,n&&!n(t)||t.headers.has(W)?r(t):e(function n(o,u){var i=t;return o&&(i=i.clone()).headers.set(W,"Bearer "+o),r(i).then(function(t){return B(e,t,u,n,function(){return t})})}))}function V(e,n,t){var r=new WeakMap,o=function(e,n){return e.headers[W]="Bearer "+n,e};return t.interceptors.request.use(function(t){return n&&!n(t)||t.headers[W]?t:e(function(e,n){return r.set(t,n),e?o(t,e):t})}),t.interceptors.response.use(void 0,function(n){return B(e,(n=n||{}).response,r.get(n.config),function(e){return t.create()(o(n.config,e))},function(){return O(n)})}),t}function _(e,n){return F.bind(0,e.acquireToken,n)}function D(e,n){return V.bind(0,e.acquireToken,n)}var G=a.createApiClient;function K(e,n){this.baseUrl=e,this.request=G(e,{request:n,error:function(e){if(401===e.status)throw y(z)}})}g("get post put patch delete",function(e,n){h(K.prototype,n,function(e,t,r){return this.request[n](e,t,r)})});var Q=K,X=U;Object.assign(X,c);var Y=X;return u=u.default}()});
//# sourceMappingURL=brew-auth.min.js.map