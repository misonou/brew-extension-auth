/*! @misonou/brew-extension-auth v0.3.2 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports.Auth=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,(function(e,n){return function(){"use strict";var t={760:function(n){n.exports=e},231:function(e){e.exports=n}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var u=r[e]={exports:{}};return t[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return function(){o.d(u,{default:function(){return K}});var e={};o.r(e),o.d(e,{invalidCredential:function(){return E},loggedIn:function(){return A},noProvider:function(){return H}});var n={};o.r(n),o.d(n,{AuthError:function(){return e},AuthProvider:function(){return z},JSONClient:function(){return D},createAxiosMiddleware:function(){return W},createFetchMiddleware:function(){return N},default:function(){return G}});var t=o(760),r=t.addExtension,i=t.combinePath,c=o(231),a=c.util,f=a.catchAsync,s=a.defineHiddenProperty,d=a.defineObservableProperty,l=a.each,p=a.errorWithCode,h=a.exclude,v=a.extend,g=a.is,y=a.isErrorWithCode,b=a.isFunction,w=a.makeArray,m=a.makeAsync,k=a.mapRemove,T=a.pick,x=a.pipe,P=a.reject,j=a.resolve,q=a.resolveAll,O=a.throws,S=c.dom.reportError,A="brew/auth-logged-in",H="brew/auth-no-provider",E="brew/auth-invalid-credential",I="brew.auth",C=r("auth",["router"],(function(e,n){var t,r,o=d(e,"user",null,!0),u=w(n.providers||n.provider),c={interaction:n.interaction||"redirect"},a=new Map,s=i(location.origin,e.toHref("/")),l=e.cache;function h(n){var o={redirectUri:s,revokeSession:function(o){t!==n||o&&r.accountId!==o||(t=null,e.emit("sessionEnded")||U())}};return a.set(n,o),m(n.init).call(n,o).catch((function(e){y(e,E)||S(e)}))}function g(e,n,t){return void 0===t?e:e.filter((function(e){return e[n]===t}))}function C(e){if(e.provider)return g(u,"key",e.provider)[0];var n=u;return n=g(n,"authType",e.authType),n=g(n,"providerType",e.providerType),e.loginHint?j(0).then((function t(r){var o=n[r];return o&&j(o.isHandleable(e.loginHint)).then((function(e){return e?o:t(r+1)}))})):n[1]?void 0:n[0]}function M(e,n){l.set(I,{provider:e,returnPath:n})}function z(n){var t=k(l,I)||{};t.provider===n&&f(e.navigate(t.returnPath))}function R(u,i){var c={provider:u.key,providerType:u.providerType,account:i.account};return t=u,r=i,(n.resolveUser?m(n.resolveUser)(c):j(c.account)).then((function(n){o(n),z(u.key),e.emit("login",{user:n})}),(function(e){throw U(),e}))}function U(){var n=e.user;t=null,r=null,o(null),z(""),n&&e.emit("logout",{user:n})}function J(e,n,t,r){var o=m(e[n]).call(e,v({},c,t),a.get(e));return o.catch((function(){l.delete(I)})),o.then(r)}e.define({resolveAuthProvider:function(e){return j(C(e)).then((function(e){return e?T(e,["key","authType","providerType"]):null}))},acquireToken:function(e){var n=t,o=r,u=!0===e;return e=b(e)||j,n?!u&&r.expiresOn>Date.now()?e(r.accessToken,!0):n.refresh(r,a.get(n)).then((function(o){return t===n&&(r=o),e(o.accessToken,!1)}),(function(n){return u?O(n):e(o.accessToken,!1)})):e(null,!1)},login:function(r){return t?P(p(A)):j(C(r=r||{})).then((function(t){if(!t)throw p(H);return M(t.key,r.returnPath||n.postLoginPath||e.path),J(t,"login",T(r,["loginHint","password"]),R.bind(0,t))}))},logout:function(o){return t?(M("",(o=o||{}).returnPath||n.postLogoutPath||e.path),J(t,"logout",{accountId:r.accountId,singleLogout:o.singleLogout},U)):j(U())}}),e.beforeInit((function(){return q(u.map(h),(function(e){var n=u.indexOf(C(l.get(I)||{}));return e[n]||(n=e.findIndex(x)),n>=0?R(u[n],e[n]).catch(S):U()}))}))})),M=c.util.bind,z={from:function(e,n){var t=window.localStorage,r="brew.auth."+e,o=r+".id";function u(e){return e?(t[r]=JSON.stringify(h(e,["account"])),t[o]=e.accountId):(delete t[r],delete t[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){M(window,"storage",(function(n){n.storageArea===t&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)}));var i=function(){try{return JSON.parse(t[r])}catch(e){}}();return i&&n.refresh(i).then(u)},login:function(e){return n.login(e).then(u)},logout:function(e){return n.logout(e).then(u.bind(0,void 0))},refresh:function(e){return n.refresh(e).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}},R="authorization";function U(e,n,t,r,o){return t&&n&&401===n.status?e(!0).then(r,o):o()}function J(e,n,t,r){return!g(t,Request)||r&&!b(r)?J(e,n,new Request(t,r)):(r=r||window.fetch,n&&!n(t)||t.headers.has(R)?r(t):e((function n(o,u){var i=t;return o&&(i=i.clone()).headers.set(R,"Bearer "+o),r(i).then((function(t){return U(e,t,u,n,(function(){return t}))}))})))}function L(e,n,t){var r=new WeakMap,o=function(e,n){return e.headers[R]="Bearer "+n,e};return t.interceptors.request.use((function(t){return n&&!n(t)||t.headers[R]?t:e((function(e,n){return r.set(t,n),e?o(t,e):t}))})),t.interceptors.response.use(void 0,(function(n){return U(e,(n=n||{}).response,r.get(n.config),(function(e){return t.create()(o(n.config,e))}),(function(){return P(n)}))})),t}function N(e,n){return J.bind(0,e.acquireToken,n)}function W(e,n){return L.bind(0,e.acquireToken,n)}var B=t.ErrorCode.apiError;function F(e,n,t){if(e.ok)return n;throw p(401===e.status?E:B,"",{data:n,error:t||null,status:e.status})}function V(e,n){return e.headers.set("accept","application/json"),(n||fetch)(e).then((function(e){return e.json().then((function(n){return F(e,n)}),(function(n){return F(e,null,n)}))}))}function _(e,n){n=n||function(e,n){return n(e)},this.baseUrl=e,this.request=function(t,r){return t=g(t,Request)||new Request(i(e,t),r),n(t,V)}}l("get post put patch delete",(function(e,n){var t=n.toUpperCase();s(_.prototype,n,(function(e,r,o){return this.request(e,"get"===n?r:function(e,n,t){return v({},t=t||{},{method:e,body:JSON.stringify(n),headers:v({},t.headers,{"content-type":"application/json"})})}(t,r,o))}))}));var D=_,G=C;Object.assign(G,n);var K=G}(),u=u.default}()}));
//# sourceMappingURL=brew-auth.min.js.map