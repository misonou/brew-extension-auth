/*! @misonou/brew-extension-auth v0.3.0 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports.Auth=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,(function(e,n){return function(){"use strict";var r={760:function(n){n.exports=e},231:function(e){e.exports=n}},t={};function o(e){var n=t[e];if(void 0!==n)return n.exports;var u=t[e]={exports:{}};return r[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var r in n)o.o(n,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return function(){o.d(u,{default:function(){return D}});var e={};o.r(e),o.d(e,{invalidCredential:function(){return H},loggedIn:function(){return S},noProvider:function(){return A}});var n={};o.r(n),o.d(n,{AuthError:function(){return e},AuthProvider:function(){return z},JSONClient:function(){return W},createAxiosMiddleware:function(){return N},createFetchMiddleware:function(){return L},default:function(){return _}});var r=o(760),t=r.addExtension,i=r.combinePath,c=o(231),a=c.util,f=a.catchAsync,s=a.defineHiddenProperty,d=a.defineObservableProperty,l=a.each,p=a.errorWithCode,h=a.exclude,v=a.extend,g=a.is,y=a.isFunction,b=a.makeArray,w=a.makeAsync,m=a.mapRemove,k=a.pick,T=a.pipe,x=a.reject,P=a.resolve,j=a.resolveAll,q=a.throws,O=c.dom.reportError,S="brew/auth-logged-in",A="brew/auth-no-provider",H="brew/auth-invalid-credential",I="brew.auth",E=t("auth",["router"],(function(e,n){var r,t,o=d(e,"user",null,!0),u=b(n.providers||n.provider),c={interaction:n.interaction||"redirect"},a=new Map,s=i(location.origin,e.toHref("/")),l=e.cache;function h(n){var o={redirectUri:s,revokeSession:function(o){r!==n||o&&t.accountId!==o||(r=null,e.emit("sessionEnded")||C())}};return a.set(n,o),P(n.init(o)).catch((function(e){O(e)}))}function g(e,n,r){return void 0===r?e:e.filter((function(e){return e[n]===r}))}function H(e){if(e.provider)return g(u,"key",e.provider)[0];var n=u;return n=g(n,"authType",e.authType),n=g(n,"providerType",e.providerType),e.loginHint?P(0).then((function r(t){var o=n[t];return o&&P(o.isHandleable(e.loginHint)).then((function(e){return e?o:r(t+1)}))})):n[1]?void 0:n[0]}function E(e,n){l.set(I,{provider:e,returnPath:n})}function M(n){var r=m(l,I)||{};r.provider===n&&f(e.navigate(r.returnPath))}function z(u,i){var c={provider:u.key,providerType:u.providerType,account:i.account};return r=u,t=i,(n.resolveUser?w(n.resolveUser)(c):P(c.account)).then((function(n){o(n),M(u.key),e.emit("login",{user:n})}),(function(e){throw C(),e}))}function C(){var n=e.user;r=null,t=null,o(null),M(""),n&&e.emit("logout",{user:n})}function R(e,n,r,t){var o=w(e[n]).call(e,v({},c,r),a.get(e));return o.catch((function(){l.delete(I)})),o.then(t)}e.define({resolveAuthProvider:function(e){return P(H(e)).then((function(e){return e?k(e,["key","authType","providerType"]):null}))},acquireToken:function(e){var n=r,o=t,u=!0===e;return e=y(e)||P,n?!u&&t.expiresOn>Date.now()?e(t.accessToken,!0):n.refresh(t,a.get(n)).then((function(o){return r===n&&(t=o),e(o.accessToken,!1)}),(function(n){return u?q(n):e(o.accessToken,!1)})):e(null,!1)},login:function(t){return r?x(p(S)):P(H(t=t||{})).then((function(r){if(!r)throw p(A);return E(r.key,t.returnPath||n.postLoginPath||e.path),R(r,"login",k(t,["loginHint","password"]),z.bind(0,r))}))},logout:function(o){return r?(E("",(o=o||{}).returnPath||n.postLogoutPath||e.path),R(r,"logout",{accountId:t.accountId,singleLogout:o.singleLogout},C)):P(C())}}),e.beforeInit((function(){return j(u.map(h),(function(e){var n=u.indexOf(H(l.get(I)||{}));return e[n]||(n=e.findIndex(T)),n>=0?z(u[n],e[n]):C()}))}))})),M=c.util.bind,z={from:function(e,n){var r=window.localStorage,t="brew.auth."+e,o=t+".id";function u(e){return e?(r[t]=JSON.stringify(h(e,["account"])),r[o]=e.accountId):(delete r[t],delete r[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){M(window,"storage",(function(n){n.storageArea===r&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)}));var i=function(){try{return JSON.parse(r[t])}catch(e){}}();return i&&n.refresh(i).then(u)},login:function(e){return n.login(e).then(u)},logout:function(e){return n.logout(e).then(u.bind(0,void 0))},refresh:function(e){return n.refresh(e).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}},C="authorization";function R(e,n,r,t,o){return r&&n&&401===n.status?e(!0).then(t,o):o()}function U(e,n,r,t){return!g(r,Request)||t&&!y(t)?U(e,n,new Request(r,t)):(t=t||window.fetch,n&&!n(r)||r.headers.has(C)?t(r):e((function n(o,u){var i=r;return o&&(i=i.clone()).headers.set(C,"Bearer "+o),t(i).then((function(r){return R(e,r,u,n,(function(){return r}))}))})))}function J(e,n,r){var t=new WeakMap,o=function(e,n){return e.headers[C]="Bearer "+n,e};return r.interceptors.request.use((function(r){return n&&!n(r)||r.headers[C]?r:e((function(e,n){return t.set(r,n),e?o(r,e):r}))})),r.interceptors.response.use(void 0,(function(n){return R(e,(n=n||{}).response,t.get(n.config),(function(e){return r.create()(o(n.config,e))}),(function(){return x(n)}))})),r}function L(e,n){return U.bind(0,e.acquireToken,n)}function N(e,n){return J.bind(0,e.acquireToken,n)}var B=r.ErrorCode.apiError;function F(e,n){return e.headers.set("accept","application/json"),(n||fetch)(e).then((function(e){return e.json().then((function(n){if(e.ok)return n;throw p(B,"",{data:n})}),(function(n){if(e.ok)return null;throw p(B,"",{error:n})}))}))}function V(e,n){n=n||function(e,n){return n(e)},this.baseUrl=e,this.request=function(r,t){return r=g(r,Request)||new Request(i(e,r),t),n(r,F)}}l("get post put patch delete",(function(e,n){var r=n.toUpperCase();s(V.prototype,n,(function(e,t,o){return this.request(e,"get"===n?t:function(e,n,r){return v({},r=r||{},{method:e,body:JSON.stringify(n),headers:v({},r.headers,{"content-type":"application/json"})})}(r,t,o))}))}));var W=V,_=E;Object.assign(_,n);var D=_}(),u=u.default}()}));
//# sourceMappingURL=brew-auth.min.js.map