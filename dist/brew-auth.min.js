/*! @misonou/brew-extension-auth v0.2.1 | (c) misonou | https://misonou.github.io */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("brew-js"),require("zeta-dom")):"function"==typeof define&&define.amd?define("@misonou/brew-extension-auth",["brew-js","zeta-dom"],n):"object"==typeof exports?exports.Auth=n(require("brew-js"),require("zeta-dom")):(e.brew=e.brew||{},e.brew.Auth=n(e.brew,e.zeta))}(self,(function(e,n){return function(){"use strict";var t={760:function(n){n.exports=e},231:function(e){e.exports=n}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var u=r[e]={exports:{}};return t[e](u,u.exports,o),u.exports}o.d=function(e,n){for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return function(){o.d(u,{default:function(){return _}});var e={};o.r(e),o.d(e,{invalidCredential:function(){return H},loggedIn:function(){return S},noProvider:function(){return A}});var n={};o.r(n),o.d(n,{AuthError:function(){return e},AuthProvider:function(){return M},JSONClient:function(){return V},createAxiosMiddleware:function(){return N},createFetchMiddleware:function(){return L},default:function(){return W}});var t=o(760),r=t.addExtension,i=t.combinePath,c=o(231),a=c.util,f=a.catchAsync,s=a.defineHiddenProperty,d=a.defineObservableProperty,l=a.each,p=a.errorWithCode,h=a.exclude,v=a.extend,g=a.is,y=a.isFunction,b=a.makeArray,w=a.makeAsync,m=a.mapRemove,k=a.pick,x=a.pipe,P=a.reject,T=a.resolve,j=a.resolveAll,q=a.throws,O=c.dom.reportError,S="brew/auth-logged-in",A="brew/auth-no-provider",H="brew/auth-invalid-credential",I="brew.auth",z=r("auth",["router"],(function(e,n){var t,r,o=d(e,"user",null,!0),u=b(n.providers),c={interaction:n.interaction||"redirect"},a=new Map,s=i(location.origin,e.toHref("/")),l=e.cache;function h(n){var o={redirectUri:s,revokeSession:function(o){t!==n||o&&r.accountId!==o||(t=null,e.emit("sessionEnded")||M())}};return a.set(n,o),T(n.init(o)).catch((function(e){O(e)}))}function g(e){return e.provider?u.find((function(n){return n.key===e.provider})):e.loginHint?T(0).then((function n(t){var r=u[t];return r&&T(r.isHandleable(e.loginHint)).then((function(e){return e?r:n(t+1)}))})):u[1]?void 0:u[0]}function H(e,n){l.set(I,{provider:e,returnPath:n})}function z(n){var t=m(l,I)||{};t.provider===n&&f(e.navigate(t.returnPath))}function E(u,i){var c={provider:u.key,providerType:u.providerType,account:i.account};return t=u,r=i,w(n.resolveUser)(c).then((function(n){o(n),z(u.key),e.emit("login",{user:n})}),(function(e){throw M(),e}))}function M(){var n=e.user;t=null,r=null,o(null),z(""),n&&e.emit("logout",{user:n})}function C(e,n,t,r){var o=w(e[n]).call(e,v({},c,t),a.get(e));return o.catch((function(){l.delete(I)})),o.then(r)}e.define({resolveAuthProvider:function(e){return T(g(e)).then((function(e){return e?k(e,["key","authType","providerType"]):null}))},acquireToken:function(e){var n=t,o=r,u=!0===e;return e=y(e)||T,n?!u&&r.expiresOn>Date.now()?e(r.accessToken,!0):n.refresh(r,a.get(n)).then((function(o){return t===n&&(r=o),e(o.accessToken,!1)}),(function(n){return u?q(n):e(o.accessToken,!1)})):e(null,!1)},login:function(r){return t?P(p(S)):T(g(r=r||{})).then((function(t){if(!t)throw p(A);return H(t.key,r.returnPath||n.postLoginPath||e.path),C(t,"login",k(r,["loginHint","password"]),E.bind(0,t))}))},logout:function(o){return t?(H("",(o=o||{}).returnPath||n.postLogoutPath||e.path),C(t,"logout",{accountId:r.accountId,singleLogout:o.singleLogout},M)):T(M())}}),e.beforeInit((function(){return j(u.map(h),(function(e){var n=u.indexOf(g(l.get(I)||{}));return e[n]||(n=e.findIndex(x)),n>=0?E(u[n],e[n]):M()}))}))})),E=c.util.bind,M={from:function(e,n){var t=window.localStorage,r="brew.auth."+e,o=r+".id";function u(e){return e?(t[r]=JSON.stringify(h(e,["account"])),t[o]=e.accountId):(delete t[r],delete t[o]),e}return{key:e,authType:n.authType,providerType:n.providerType,init:function(e){E(window,"storage",(function(n){n.storageArea===t&&(n.key===o&&n.oldValue||null===n.key)&&e.revokeSession(n.oldValue)}));var i=function(){try{return JSON.parse(t[r])}catch(e){}}();return i&&n.refresh(i).then(u)},login:function(e){return n.login(e).then(u)},logout:function(e){return n.logout(e).then(u.bind(0,void 0))},refresh:function(e){return n.refresh(e).then(u)},isHandleable:function(e){return n.isHandleable(e)}}}};function C(e,n,t,r,o){return t&&n&&401===n.status?e(!0).then(r,o):o()}function R(e,n,t){return!g(n,Request)||t&&!y(t)?R(e,new Request(n,t)):(t=t||window.fetch,e((function r(o,u){var i=n;return o&&(i=i.clone()).headers.set("authorization","Bearer "+o),t(i).then((function(n){return C(e,n,u,r,(function(){return n}))}))})))}function J(e,n){var t=new WeakMap,r=function(e,n){return e.headers.authorization="Bearer "+n,e};return n.interceptors.request.use((function(n){return m(t,n)?n:e((function(e,o){return t.set(n,o),e?r(n,e):n}))})),n.interceptors.response.use(void 0,(function(o){return C(e,(o=o||{}).response,t.get(o.config),(function(e){return n(r(o.config,e))}),(function(){return P(o)}))})),n}function L(e){return R.bind(0,e.acquireToken)}function N(e){return J.bind(0,e.acquireToken)}var U=t.ErrorCode.apiError;function B(e,n){return e.headers.set("accept","application/json"),(n||fetch)(e).then((function(e){return e.json().then((function(n){if(e.ok)return n;throw p(U,"",{data:n})}),(function(n){if(e.ok)return null;throw n}))}))}function F(e,n){n=n||function(e,n){return n(e)},this.baseUrl=e,this.request=function(t,r){return t=g(t,Request)||new Request(i(e,t),r),n(t,B)}}l("get post put patch delete",(function(e,n){var t=n.toUpperCase();s(F.prototype,n,(function(e,r,o){return this.request(e,"get"===n?r:function(e,n,t){return v({},t=t||{},{method:e,body:JSON.stringify(n),headers:v({},t.headers,{"content-type":"application/json"})})}(t,r,o))}))}));var V=F,W=z;Object.assign(W,n);var _=W}(),u=u.default}()}));
//# sourceMappingURL=brew-auth.min.js.map